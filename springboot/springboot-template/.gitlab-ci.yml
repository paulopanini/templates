image: jelastic/maven:3.8.6-openjdk-20.ea-b24

stages:
  - maven
  - docker
  - deploy
  
build:
  stage: maven
  rules: 
    - if: $CI_COMMIT_BRANCH
  script: "mvn install -B"
  artifacts:
    paths:
      - target/*
    expire_in: 1 day

build-docker-image:
  stage: docker
  image: docker:20.10.16
  rules: 
    - if: $CI_COMMIT_BRANCH
  services:
    - docker:20.10.16-dind
  script:
    - export VERSION=$(date +%s)
    - docker build . --file Dockerfile --tag paulopanini/${{values.name}}:latest
    - docker login -u paulopanini -p dckr_pat_WeZbTsfCKF2GFuMlhYQXXYjwN7g 
    - docker push paulopanini/${{values.name}}:latest

deploy-uat:
  stage: deploy
  rules: 
    - if: $CI_COMMIT_MESSAGE =~ /.*#deployuat.*/ && $CI_COMMIT_BRANCH
  when: manual
  before_script:
    - git remote set-url origin https://oauth2:glpat-Ty4AVdC2TyuBku7GAvpC@gitlab.com/paulopanini/${{values.name}}.git
  script:
    - tag=1.0-${CI_COMMIT_SHORT_SHA}
    - git tag $tag
    - git push origin $tag

first-deploy:
  stage: deploy
  rules: 
    - if: $CI_COMMIT_MESSAGE =~ /.*#backstage.*/ && $CI_COMMIT_BRANCH
  before_script:
    - git remote set-url origin https://oauth2:glpat-Ty4AVdC2TyuBku7GAvpC@gitlab.com/paulopanini/${{values.name}}.git
  script:
    - tag=1.0-${CI_COMMIT_SHORT_SHA}
    - git tag $tag
    - git push origin $tag